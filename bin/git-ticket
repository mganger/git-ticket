#!/bin/bash

case $1 in 
	start)
		ti checkout $2
		tmp=$(mktemp)
		ti show > $tmp

		title=$(grep Title $tmp | cut -d: -f 2 | xargs | sed -r 's/\s+/-/g' | tr '[:upper:]' '[:lower:]')
		id=$(grep TicId $tmp | cut -d: -f 2 | xargs | cut -c 1-6)
		tag=$(grep Tags $tmp | cut -d: -f 2 | cut -d, -f 1 | xargs)

		git flow $tag start $id-$title
		;;
	list)
		case $2 in
			--number|-n)
				ti list | tail -n +4 | head -n -1 | cat -n
				;;
			*)
				ti $@
				;;
		esac
		;;
	finish)
			id=$(git symbolic-ref --short HEAD | cut -d/ -f 2 | cut -d- -f 1 | xargs)
			tag=$(git symbolic-ref --short HEAD | cut -d/ -f 1 | xargs)
			ti state $id resolved
			git flow feature finish
		;;
	current)
		id=$(git symbolic-ref --short HEAD | cut -d/ -f 2 | cut -d- -f 1 | xargs)
		echo [$id]
		;;
	init)
		echo '#!/bin/bash
		BRANCH_NAME=$(git symbolic-ref --short HEAD | cut -d- -f 1 | cut -d/ -f 2 | xargs)
		if [ -n $BRANCH_NAME ] && ! [[ $BRANCH_NAME == master ]] && ! [[ $BRANCH_NAME == develop ]]
		then
			sed -i.bak -e "1s/^/[$BRANCH_NAME] /" $1
		fi' >    .git/hooks/commit-msg
		chmod +x .git/hooks/commit-msg
		ti init
		;;
	*)
		ti $@
		;;
esac
