#!/bin/bash

BRANCH=$(git status | head -1 | sed -r 's/On branch (.*)$/\1/')

get_string(file, string) {
	grep $string $file | sed -r s/${string}\s*:\s*//
}

case $1 in 
	init)
		if git checkout --orphan ticket 2> /dev/null
		then
			echo Created new branch \'ticket\'
			#remove files in branch
			rm -rf $(ls)

			#make ticket directory
			mkdir ticket
			touch ticket/.ticket
			git add -A
			git commit -m 'Initial ticket branch commit'
			git checkout $BRANCH
		else
			echo Tickets already initialized
		fi
		;;

	assign)
		;;
	attach)
		;;
	checkout)
		;;
	comment)
		;;
	list)
		;;
	new)
		if git checkout ticket 2> /dev/null
		then
			TMP_FILE=$(mktemp)

			#copy file into it
			cp new_issue $TMP_FILE
			vim $TMP_FILE

			TITLE= $(get_string $TMP_FILE title)
			DESC=  $(get_string $TMP_FILE desc)
			TYPE=  $(get_string $TMP_FILE 'type')
			ASSIGN=$(get_string $TMP_FILE assign)
			ROOT=  $(get_string $TMP_FILE root)

			HASH=$(echo -n $TITLE | sha256sum)

			#create the issue by making directories
			mkdir -p $ROOT/$TITLE
			cd $ROOT/$TITLE
			cat $ASSIGN > assigned-to
			cat $DESC   > description
			cat $TYPE   > 'type'
			cat $HASH   > 'hash'
			cat open    > 'status'

			cd -
			git add -A
			git commit -m "Added ticket ${TITLE}"
		else
			echo Tickets have not been initialized yet
		fi
		;;
	points)
		;;
	recent)
		;;
	show)
		;;
	state)
		;;
	sync)
		;;
	*)
		;;
esac
